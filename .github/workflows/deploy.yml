name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_KEY }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT || '22' }}
          envs: GOOGLE_CREDENTIALS_JSON
          command_timeout: 45m
          script: |
            set -ex
            
            # --- 1. SYSTEM PREPARATION ---
            # Ensure Docker is installed
            if ! command -v docker &> /dev/null; then
                curl -fsSL https://get.docker.com -o get-docker.sh
                sh get-docker.sh
            fi

            # --- 2. REPO SYNC ---
            mkdir -p /root/scrapers
            cd /root/scrapers
            
            # Initialize or Pull
            if [ -d ".git" ]; then
                git remote set-url origin https://github.com/dev-noaman/scrapers.git
                git fetch origin main
                git reset --hard origin/main
            else
                cd /root
                rm -rf scrapers
                git clone https://github.com/dev-noaman/scrapers.git
                cd scrapers
            fi

            # --- 2.5. INJECT SECRETS ---
            echo "--- Injecting Google Credentials ---"
            mkdir -p /root/scrapers/docker-scraper/drive
            echo "$GOOGLE_CREDENTIALS_JSON" > /root/scrapers/docker-scraper/drive/google-credentials.json
            
            # --- 3. DEPLOY SERVICES ---
            
            # A. Legacy Services (API-php & API-node)
            # We keep these running on 8080 and 8081
            
            echo "--- Deploying API-php (Port 8080) ---"
            cd /root/scrapers/API-php
            docker composer down --remove-orphans || docker-compose down --remove-orphans || true
            docker compose up -d --build || docker-compose up -d --build

            echo "--- Deploying API-node (Port 8081) ---"
            cd /root/scrapers/API-node
            docker compose down --remove-orphans || docker-compose down --remove-orphans || true
            docker compose up -d --build || docker-compose up -d --build

            # B. New Root Services (Portal & Scraper)
            # Portal on 8082, Scraper (background)
            
            echo "--- Deploying Root Services (Portal:8085 + Scraper) ---"
            cd /root/scrapers
            
            # Aggressive Cleanup to fix 'ContainerConfig' errors
            echo "--- Cleaning up stuck containers ---"
            docker stop single_window_portal single_window_scraper || true
            docker rm -f single_window_portal single_window_scraper || true
            docker network prune -f || true
            
            # Ensure the old stack is down
            docker compose down --remove-orphans || docker-compose down --remove-orphans || true
            
            # Build and Start with Force Recreate
            echo "--- Starting new containers ---"
            docker compose up -d --build --force-recreate || docker-compose up -d --build --force-recreate

            # --- 4. HOST NGINX CONFIGURATION ---
            # Ensures VPS maps domains to the correct local ports
            
            echo "--- Updating Nginx Config ---"
            cat > /etc/nginx/sites-available/noaman.cloud << 'EOF'
            server {
                listen 80 default_server;
                server_name noaman.cloud www.noaman.cloud;

                # Portal (from Root Docker Compose) -> 8085
                location / {
                    proxy_pass http://127.0.0.1:8085/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                }

                # API-php -> 8080
                location /api-php/ {
                    proxy_pass http://127.0.0.1:8080/;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_read_timeout 300;
                }

                # API-node -> 8081
                location /api-node/ {
                    proxy_pass http://127.0.0.1:8081/;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_read_timeout 300;
                }
            }
            EOF
            
            ln -sf /etc/nginx/sites-available/noaman.cloud /etc/nginx/sites-enabled/
            nginx -t && systemctl reload nginx

            echo "--- DEPLOYMENT SUCCESSFUL ---"
