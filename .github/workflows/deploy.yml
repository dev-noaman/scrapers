name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          command_timeout: 45m
          script: |
            set -ex
            
            # 1. SYSTEM PREPARATION
            echo "--- Installing Host Nginx & Certbot ---"
            apt-get update
            apt-get install -y nginx certbot python3-certbot-nginx ufw curl

            # 2. FIREWALL
            echo "--- Configuring Firewall ---"
            ufw allow 80/tcp || true
            ufw allow 443/tcp || true
            ufw allow 22/tcp || true

            # 3. DOCKER SETUP
            if ! command -v docker &> /dev/null; then
                curl -fsSL https://get.docker.com -o get-docker.sh
                sh get-docker.sh
                apt-get install -y docker-compose-plugin
            fi
            systemctl enable --now docker

            # 4. REPO SYNC
            mkdir -p /root/scrapers
            cd /root/scrapers
            if [ -d ".git" ]; then
                git remote set-url origin https://github.com/dev-noaman/scrapers.git
                git fetch origin main
                git reset --hard origin/main
            else
                cd /root
                rm -rf scrapers
                git clone https://github.com/dev-noaman/scrapers.git
                cd scrapers
            fi

            # 5. DOCKER DEPLOYMENT
            DOCKER_COMPOSE="docker compose"
            if ! $DOCKER_COMPOSE version > /dev/null 2>&1; then DOCKER_COMPOSE="docker-compose"; fi

            echo "--- Deploying APIs ---"
            cd /root/scrapers/API-php
            $DOCKER_COMPOSE down --remove-orphans || true
            $DOCKER_COMPOSE up -d --build

            cd /root/scrapers/API-node
            $DOCKER_COMPOSE down --remove-orphans || true
            $DOCKER_COMPOSE up -d --build

            # 6. HOST NGINX CONFIGURATION (Safer Heredoc)
            echo "--- Writing Nginx Config ---"
            cat > /etc/nginx/sites-available/noaman.cloud <<'EOF'
server {
    listen 80;
    server_name noaman.cloud;

    location /api-php/ {
        proxy_pass http://127.0.0.1:8080/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300;
    }

    location /api-node/ {
        proxy_pass http://127.0.0.1:8081/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300;
    }
}
EOF
            ln -sf /etc/nginx/sites-available/noaman.cloud /etc/nginx/sites-enabled/
            rm -f /etc/nginx/sites-enabled/default || true
            nginx -t
            systemctl restart nginx

            # 7. AUTOMATED SSL
            echo "--- Certbot SSL ---"
            if [ ! -d "/etc/letsencrypt/live/noaman.cloud" ]; then
                certbot --nginx -d noaman.cloud --non-interactive --agree-tos -m noaman.cloud@gmail.com || echo "SSL failed"
            else
                certbot --nginx -d noaman.cloud --non-interactive --reinstall || echo "SSL already exists"
            fi

            # 8. VERIFICATION
            sleep 5
            docker ps
            curl -sI http://localhost:8080/health || true
            curl -sI http://localhost:8081/health || true

            echo "--- DEPLOYMENT SUCCESS ---"
