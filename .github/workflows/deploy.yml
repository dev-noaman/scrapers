name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            set -e  # Exit on error

            # ---------------------------------------------------------
            # 1. Fresh Installation Check (Install Docker if missing)
            # ---------------------------------------------------------
            if ! command -v docker &> /dev/null; then
                echo "Docker not found. Installing Docker and dependencies..."
                
                # Update and install prerequisite packages
                sudo apt-get update
                sudo apt-get install -y ca-certificates curl gnupg lsb-release git

                # Install Docker
                curl -fsSL https://get.docker.com -o get-docker.sh
                sudo sh get-docker.sh
                
                # Install Docker Compose Plugin
                sudo apt-get install -y docker-compose-plugin
                
                # Start Docker service
                sudo systemctl start docker
                sudo systemctl enable docker
                
                echo "Docker installed successfully."
            else
                echo "Docker is already installed."
            fi

            # ---------------------------------------------------------
            # 2. Code Update
            # ---------------------------------------------------------
            # Navigate to project directory or clone if not exists
            if [ -d "/root/scrapers" ]; then
              echo "Updating existing repository..."
              cd /root/scrapers
              git reset --hard
              git pull origin main
            else
              echo "Cloning repository..."
              cd /root
              git clone https://github.com/dev-noaman/scrapers.git
              cd scrapers
            fi
            
            # ---------------------------------------------------------
            # 3. Deploy API-php
            # ---------------------------------------------------------
            echo "Deploying API-php..."
            cd /root/scrapers/API-php
            docker compose down --remove-orphans
            docker compose up -d --build --wait
            
            # ---------------------------------------------------------
            # 4. Deploy API-node
            # ---------------------------------------------------------
            echo "Deploying API-node..."
            cd /root/scrapers/API-node
            docker compose down --remove-orphans
            docker compose up -d --build --wait
            
            # ---------------------------------------------------------
            # 5. Cleanup
            # ---------------------------------------------------------
            echo "Cleaning up..."
            docker system prune -f
            
            echo "Deployment completed successfully! Containers are healthy and ready."
